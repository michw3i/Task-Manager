<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Task Manager | Financials</title>
    <link href="https://fonts.cdnfonts.com/css/dynapuff" rel="stylesheet">
    <style>
  :root{
    --bg-hi:#AFD5C7;
    --bg-mid:#6ba9bb;
    --bg-lo:#6e65b5;
    --ink:#ffffff;       /* all fonts white */
    --muted:#d9d9d9;
    --accent:#ffffff;    /* cyan */
    --accent-2:#6e65b5;  /* teal */
    --stroke:#AFD5C7;
    --chip:#d9d9d9;
    --radius:16px;
    --shadow:0 10px 30px rgba(110, 101, 181,.5);
  }

  *{ box-sizing:border-box }
  h2 {
    color: #fff !important;
    font-weight: 700;
    margin: 22px 0 10px;
    font-size: clamp(16px, 2.2vw, 20px);
    }
  

  body{
    margin:0%;
    padding: 0%;
    color:var(--ink);
    background:
      radial-gradient(1200px 700px at 50% -10%, #6e65b5 0%, transparent 30%),
      /*radial-gradient(900px 500px at 120% 10%, #6ba9bb 0%, transparent 70%), */
      
      linear-gradient(180deg, var(--bg-mid), var(--bg-hi) 40%, var(--bg-lo) 100%);
    min-height: 200%;
    font-family: 'DynaPuff', sans-serif;
    letter-spacing:.2px;
  }

  /* Top nav */
  ul.navigation{
      list-style:none; margin:0;
      font-family: 'DynaPuff', sans-serif;
      letter-spacing: 0.18em;
      display:flex; justify-content:center;
      padding:18px 6vw;
      position:sticky; top:0; z-index:6;
      background: linear-gradient(180deg, rgba(110, 101, 181, 0.6), rgba(80, 72, 140, 0.6));
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-bottom:1px solid rgba(110, 101, 181,0.3);
    }
   ul.navigation li{ display:inline-block }
    ul.navigation a{
      text-decoration:none; color:#f3f3f3;
      padding:8px 14px;
      background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.03));
      border:1px solid rgba(110, 101, 181, 0.1);
      box-shadow: inset 0 1px 0 rgba(213, 177, 85, 0.2);
      transition: transform .15s ease, box-shadow .2s ease, background .2s ease;
    }
    ul.navigation a:hover{
      transform:translateY(-1px);
      background: linear-gradient(180deg, rgba(110, 101, 181,0.15), rgba(110, 101, 181,0.05));
      box-shadow: 0 8px 18px rgba(193, 192, 199, 0.5);
    }
  /* Page container */
  #body{
    max-width:1100px;
    margin:5% auto 5%;
  }

  h1{
    margin:0 0 6px;
    font-size:clamp(28px, 4vw, 40px);
    line-height:1.1;
    font-weight:800;
    text-shadow:0 0 30px rgba(255, 255, 255, 0.5);
  }
  h2{
    margin:22px 0 10px;
    font-size:clamp(16px, 2.2vw, 20px);
    color:var(--muted);
    font-weight:700;
  }
  

  /* Cardy fieldset */
  fieldset{
    border:1px solid var(--stroke);
    border-radius:var(--radius);
    padding:16px;
    background:linear-gradient(180deg, rgba(195, 232, 219, 0.21), rgba(195, 232, 219, 0.504));
    box-shadow:var(--shadow);
  }
  legend{
    padding:0 8px;
    color:var(--accent-2);
    font-weight:800;
    letter-spacing:.3px;
  }

  /* Inputs */
  #financialsFieldset input[type="text"],
  #financialsFieldset input[type="number"]{
    width:100%;
    margin-top:10px;
    padding:12px 14px;
    border-radius:12px;
    border:1px solid var(--stroke);
    background:var(--chip);
    color:var(--ink);
    outline:none;
    transition:border-color .15s, box-shadow .15s;
  }
  #financialsFieldset input::placeholder{ color:rgba(117, 148, 136, 0.68) }
  #financialsFieldset input:focus{
    border-color:#6e65b5;
    box-shadow:0 0 0 4px rgba(103,232,249,.12);
  }

  /* Button */
  button[type="submit"]{
    padding:12px 16px;
    border-radius:12px;
    border:1px solid rgba(103,232,249,.22);
    background:linear-gradient(90deg, rgba(110, 101, 181,.58), rgba(110, 101, 181,.56));
    color:var(--ink);
    font-weight:800;
    cursor:pointer;
    transition:transform .15s, box-shadow .15s, background .15s;
  }
  button[type="submit"]:hover{
    transform:translateY(-1px);
    box-shadow:0 10px 20px rgba(110, 101, 181,.38);
  }

  /* Table shells */
  #financialsTableContainer,
  #totalsTableContainer{
    margin-top:18px;
    background:linear-gradient(180deg, rgba(175, 213, 199,.03), rgba(175, 213, 199,.02));
    border:1px solid var(--stroke);
    border-radius:var(--radius);
    padding:14px;
    box-shadow:var(--shadow);
  }

  /* Tables */
  table{
    width:100%;
    border-collapse:separate;
    border-spacing:0;
    overflow:hidden;
    border:1px solid var(--stroke);
    border-radius:14px;
    background:rgba(175, 213, 199,.02);
    margin-bottom: 5%;
    
  }
  table thead th{
    text-align:left;
    font-size:14px;
    padding:14px 16px;
    background:linear-gradient(180deg, rgba(175, 213, 199,.12), rgba(175, 213, 199,.10));
    color:var(--ink);
    position:sticky; top:0;
    border-bottom:1px solid var(--stroke);
  }
  table tbody td{
    padding:14px 16px;
    border-bottom:1px solid var(--stroke);
    color:var(--ink);
  }
  table tbody tr{ transition:background .15s ease }
  table tbody tr:hover{ background:rgba(255, 255, 255, 0.06) }
  /* Right-align money column in both tables */
  #financialsTable td:nth-child(4),
  #financialsTable th:nth-child(4),
  #totalsTable td:nth-child(3),
  #totalsTable th:nth-child(3){
    text-align:right;
  }

  /* Empty-state row */
  #totalsTable tbody tr td[colspan="3"]{
    text-align:center;
    color:#bdbdbd;
    font-style:italic;
    padding:18px 12px;
  }

  /* Responsive: place inputs inline on wide screens */
  @media (min-width: 720px){
    #financialsFieldset{
      display:grid;
      grid-template-columns: repeat(4, 1fr) 120px;
      gap:12px;
      align-items:end;
    }
    #financialsFieldset legend{ grid-column:1/-1 }
    #financialsFieldset input{ margin-top:0 }
    #financialsFieldset button{ grid-column:5 }
  }
</style>
</head>
<body>
    <ul class="navigation">
        <li><a href="/">Home</a></li>
        <li><a href="/todo">To-do</a></li>
        <li><a href="/financials">Financials</a></li>
    </ul>

    <div id="body">
        <h1>Financials</h1>

        <!-- Financial Entry Form -->
        <form id="financialsForm">
            <fieldset id="financialsFieldset">
                <legend>Record Financial Entry</legend>
                <input type="text" id="who" placeholder="Who owes?">
                <input type="text" id="owesTo" placeholder="Owes to whom?">
                <input type="text" id="financial" placeholder="Description">
                <input type="number" id="amount" placeholder="Amount" step="0.01">
                <br><br>
                <button type="submit">Add Entry</button>
            </fieldset>
        </form>

        <!-- Financials Table -->
        <div id="financialsTableContainer">
            <h2>Financial Entries</h2>
            <table id="financialsTable">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Owes To</th>
                        <th>Description</th>
                        <th>Amount</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Table rows will be added here dynamically -->
                </tbody>
            </table>
        </div>

        <!-- Totals Table -->
        <div id="totalsTableContainer">
            <h2>Current Totals</h2>
      <div style="display:flex; justify-content:flex-end; gap:8px; margin-bottom:8px;">
        <button id="clearFinancials" title="Clear all financial entries">Clear Financials</button>
      </div>
            <table id="totalsTable">
                <thead>
                    <tr>
                        <th>From</th>
                        <th>To</th>
                        <th>Amount Owed</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Totals will be inserted here -->
                </tbody>
            </table>
        </div>

        <script>
            const STORAGE_KEY = 'taskmgr:financials';

            // balances map of "from->to" => number
            let balances = {};
            // keep a list of entries for persistence and table rebuilds
            let entries = [];
            const currency = new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            });

      document.getElementById('financialsForm').addEventListener('submit', function (event) {
                event.preventDefault();

                const who = document.getElementById('who').value.trim();
                const to = document.getElementById('owesTo').value.trim();
                const desc = document.getElementById('financial').value.trim();
                const amount = parseFloat(document.getElementById('amount').value.trim());

        if (who && to && desc && !isNaN(amount) && amount > 0 && who !== to) {
          // Add entry to in-memory list and persist
          const entry = { who, to, desc, amount };
          entries.push(entry);
          saveState();

          rebuildEntriesTable();

          updateBalances(who, to, amount);
          updateTotalsTable();

          document.getElementById('who').value = '';
          document.getElementById('owesTo').value = '';
          document.getElementById('financial').value = '';
          document.getElementById('amount').value = '';
        }
            });

      // Persist state to localStorage
      function saveState() {
        const payload = { entries, balances };
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
        } catch (e) {
          console.warn('Could not save financials to localStorage', e);
        }
      }

      // Load persisted state (if any) and populate UI
      function loadState() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return;
          const payload = JSON.parse(raw);
          entries = payload.entries || [];
          balances = payload.balances || {};
        } catch (e) {
          console.warn('Could not load financials from localStorage', e);
          entries = [];
          balances = {};
        }
      }

      // Rebuild the entries table from `entries` array
      function rebuildEntriesTable() {
        const tableBody = document.getElementById('financialsTable').getElementsByTagName('tbody')[0];
        tableBody.innerHTML = '';
        entries.forEach(ent => {
          const newRow = tableBody.insertRow();
          newRow.insertCell(0).textContent = ent.who;
          newRow.insertCell(1).textContent = ent.to;
          newRow.insertCell(2).textContent = ent.desc;
          newRow.insertCell(3).textContent = currency.format(ent.amount);
        });
      }

            function updateBalances(from, to, amount) {
                const key = `${from}->${to}`;
                const reverseKey = `${to}->${from}`;

                if (balances[reverseKey]) {
                    if (balances[reverseKey] > amount) {
                        balances[reverseKey] -= amount;
                    } else if (balances[reverseKey] < amount) {
                        balances[key] = amount - balances[reverseKey];
                        delete balances[reverseKey];
                    } else {
                        delete balances[reverseKey];
                    }
                } else {
          balances[key] = (balances[key] || 0) + amount;
                }
        saveState();
            }

            function updateTotalsTable() {
                const tbody = document.getElementById('totalsTable').getElementsByTagName('tbody')[0];
                tbody.innerHTML = '';

                let hasRows = false;

                for (const [key, value] of Object.entries(balances)) {
                    if (value > 0) {
                        const [from, to] = key.split('->');
                        const row = document.createElement('tr');
                        row.innerHTML = `<td>${from}</td><td>${to}</td><td>${currency.format(value)}</td>`;
                        tbody.appendChild(row);
                        hasRows = true;
                    }
                }

                if (!hasRows) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td colspan="3">No outstanding balances</td>`;
                    tbody.appendChild(row);
                }
        // persist current totals as they reflect balances
        saveState();
            }

      // Initialize: load persisted state and populate UI
      document.addEventListener('DOMContentLoaded', () => {
        loadState();
        rebuildEntriesTable();
        updateTotalsTable();
      });

      // Clear all persisted financials
      document.getElementById('clearFinancials').addEventListener('click', () => {
        if (!confirm('Clear all financial entries and totals? This cannot be undone.')) return;
        entries = [];
        balances = {};
        saveState();
        rebuildEntriesTable();
        updateTotalsTable();
      });
        </script>
    </div>
</body>
</html>